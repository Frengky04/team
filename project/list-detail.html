<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Detail - Dialogika</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />

    <style>
        /* CSS KHUSUS HALAMAN LIST (STACKED CARD EFFECT) */
        
        body { background-color: #e5e7eb; }
        
        /* FIX: Main Content Margin */
        .main-content {
            margin-left: 290px;
            width: calc(100% - 290px);
            padding: 40px;
            min-height: 100vh;
        }

        @media (max-width: 991px) {
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
        }

        /* --- 1. PROJECT CONTEXT CARD (UPDATED STYLE) --- */
        .project-context-card {
            max-width: 800px;
            width: 90%;
            background-color: #1f2937; /* Dark Navy sesuai list.html */
            color: white;
            margin: 20px auto -20px auto;
            padding: 20px 25px 40px 25px;
            border-radius: 16px 16px 0 0;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }

        /* Badge */
        .ph-badge {
            background: #FDE047;
            color: #854D0E;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            position: absolute;
            left: 30px;
            top: 40%;
            transform: translateY(-50%);
        }

        /* Breadcrumb Navigation Styles */
        .ph-crumb-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.95rem;
        }

        .ph-crumb-link {
            text-decoration: none;
            color: #d1d5db; /* Gray Light */
            font-weight: 500;
            transition: 0.2s;
            display: flex; align-items: center;
        }
        .ph-crumb-link:hover { color: white; }
        
        .ph-crumb-active {
            color: white;
            font-weight: 700;
            border-bottom: 2px solid #FDE047; /* Yellow underline */
        }
        
        .ph-sep { font-size: 0.8rem; color: #6b7280; } /* Separator */

        /* --- 2. MAIN LIST CARD --- */
        .main-list-card {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.1);
            margin: 0 auto 50px auto;
            padding: 50px 60px;
            position: relative;
            z-index: 2;
            border: 1px solid #d1d5db;
        }

        /* Description Expand/Collapse */
        .desc-more-link {
            color: var(--dlg-blue);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            margin-left: 5px;
        }
        .desc-more-link:hover { text-decoration: underline; }

        /* Todo Styling */
        .todo-group-label {
            font-size: 1.1rem; font-weight: 800; color: #1f2937;
            margin-top: 40px; margin-bottom: 15px; border-bottom: 3px solid #1f2937;
            display: inline-block; padding-bottom: 2px;
        }
        
        .todo-row {
            display: flex; align-items: flex-start; padding: 12px 0;
            border-bottom: 1px solid #f3f4f6; transition: 0.2s;
            font-size: 1.05rem; cursor: pointer;
        }
        .todo-row:hover { background-color: #f9fafb; padding-left: 10px; border-radius: 5px; margin-left: -10px; }
        
        .todo-check {
            width: 24px; height: 24px; margin-right: 15px; margin-top: 3px; cursor: pointer;
            border: 2px solid #cbd5e1; border-radius: 6px;
        }
        .todo-text { color: #374151; font-weight: 500; }
        .todo-row.completed .todo-text { text-decoration: line-through; color: #9ca3af; }

        @media (max-width: 768px) {
            .ph-badge { display: none; }
            .ph-crumb-container { width: 100%; justify-content: center; padding: 8px 10px; gap: 8px; font-size: 0.85rem;}
            .main-list-card { padding: 30px 20px; }
        }
    </style>
</head>
<body>

    <!-- 1. TOP BAR -->
    <nav class="top-bar">
        <div class="d-flex align-items-center">
            <button class="mobile-toggle me-3" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
            <div class="logo-center"><img src="https://www.dialogika.co/assets/img/logo.webp" height="35"></div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="profile-img-container"><img src="https://i.pravatar.cc/300?img=11" class="profile-img"></div>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <!-- 2. SIDEBAR -->
        <aside class="sidebar" id="sidebarNav">
            <div class="sidebar-scroll-wrapper">
                <div class="nav-category">Main Navigation</div>
                <a href="../home.html" class="sidebar-link active"><i class="bi bi-columns-gap"></i> Dashboard</a>
                <a href="#" class="sidebar-link"><i class="bi bi-list-columns-reverse"></i> Lineup</a>
                <div class="sidebar-copyright">&copy; 2025 PT Dialogika Persona Indonesia</div>
            </div>
        </aside>

        <!-- 3. MAIN CONTENT -->
        <main class="main-content">
            
            <!-- A. KARTU BELAKANG (BREADCRUMB NAV) -->
            <div class="project-context-card">
                <!-- Badge (Akan diisi JS) -->
                <div class="ph-badge" id="projectBadge">Loading...</div>

                <!-- Breadcrumb Navigation -->
                <div class="ph-crumb-container">
                    <!-- 1. Home -->
                    <a href="../home.html" class="ph-crumb-link" title="Dashboard">
                        <i class="bi bi-house-fill"></i>
                    </a>
                    
                    <i class="bi bi-chevron-right ph-sep"></i>

                    <!-- 2. Project Name -->
                    <a href="#" id="breadProjectLink" class="ph-crumb-link">...</a>

                    <i class="bi bi-chevron-right ph-sep"></i>

                    <!-- 3. All Lists (To-dos) -->
                    <a href="#" id="breadAllListLink" class="ph-crumb-link">To-dos</a>
                </div>

                <!-- Right Option -->
                <div class="position-absolute end-0 me-3">
                    <button class="btn btn-link text-white text-opacity-50"><i class="bi bi-three-dots"></i></button>
                </div>
            </div>

            <!-- B. KARTU DEPAN (DETAIL LIST) -->
            <div class="main-list-card">
                
                <!-- Header Area -->
                <div class="mb-5 text-center">
                    <!-- H1 untuk Judul List -->
                    <h1 class="fw-bold display-5 mb-3" id="listTitleDisplay" style="color:#111;">Loading List...</h1>
                    
                    <!-- P untuk Deskripsi (Max 8 Words) -->
                    <div class="text-muted mx-auto" style="max-width: 700px; line-height: 1.6;">
                        <span id="descShort"></span>
                        <span id="descFull" style="display:none;"></span>
                        <a href="javascript:void(0)" class="desc-more-link" id="readMoreBtn" style="display:none;" onclick="toggleDesc()">Read more...</a>
                    </div>
                </div>

                <!-- TASK LIST WRAPPER -->
                <div class="todo-list-wrapper">
                    <div class="text-center py-4"><div class="spinner-border text-primary"></div></div>
                </div>

                <!-- ADD TASK BUTTON & FORM -->
                <div class="mt-4 ps-3 border-top pt-4">
                    <button id="btn-add-detail" class="btn btn-outline-secondary rounded-pill px-4 btn-sm fw-bold" onclick="showDetailForm()">
                        <i class="bi bi-plus-lg me-1"></i> Add a to-do
                    </button>
                    
                    <div id="form-add-detail" class="mt-3" style="display:none; max-width: 600px;">
                        <input type="text" id="input-task-detail" class="form-control form-control-lg mb-2" placeholder="Describe this to-do...">
                        <div class="d-flex gap-2">
                            <button class="btn btn-success rounded-pill px-4" onclick="saveTaskDetail()">Add this to-do</button>
                            <button class="btn btn-light border rounded-pill px-4" onclick="hideDetailForm()">Cancel</button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Script JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. KONFIGURASI API ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbzsRHbU5WcucXdIhQeOFBaWQFvqO1kwGk72dHIfYWKtNcQF7ds5tTOyZNAmEWCQX_M/exec';

        // Ambil ID dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const listId = urlParams.get('listId');
        const projectId = urlParams.get('projectId');

        // Elements
        const tasksWrapper = document.querySelector('.todo-list-wrapper');
        const titleEl = document.getElementById('listTitleDisplay');
        const badgeEl = document.getElementById('projectBadge');

        // Breadcrumb Elements
        const breadProjectLink = document.getElementById('breadProjectLink');
        const breadAllListLink = document.getElementById('breadAllListLink');

        document.addEventListener("DOMContentLoaded", function() {
            if(!listId || !projectId) {
                alert("Error: Parameter URL tidak lengkap.");
                return;
            }

            // Setup Breadcrumb Links Awal
            breadProjectLink.href = `../project/project.html?id=${projectId}`;
            breadAllListLink.href = `list.html?id=${projectId}`;

            fetchDetailData();
        });

        function fetchDetailData() {
            tasksWrapper.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

            fetch(`${API_URL}?action=getProjectData&id=${projectId}`)
            .then(res => res.json())
            .then(response => {
                if(response.status === 'success') {
                    const data = response.data;
                    
                    // 1. Update Project Info di Breadcrumb & Badge
                    if(data.project) {
                        breadProjectLink.innerText = data.project.name;
                        badgeEl.innerText = data.project.department || 'Project';
                    }

                    // 2. Cari List Spesifik
                    const currentList = data.lists.find(l => l.id === listId);

                    if (currentList) {
                        renderListHeader(currentList);
                        renderTasks(currentList.tasks);
                    } else {
                        titleEl.innerText = "List Not Found";
                        tasksWrapper.innerHTML = '<div class="alert alert-warning text-center">List ID tidak ditemukan dalam project ini.</div>';
                    }
                } else {
                    alert("API Error: " + response.message);
                }
            })
            .catch(err => {
                console.error(err);
                tasksWrapper.innerHTML = '<div class="alert alert-danger text-center">Gagal terhubung ke server.</div>';
            });
        }

        // --- RENDER HEADER & DESCRIPTION (8 WORDS LIMIT) ---
        function renderListHeader(list) {
            // Set Judul H1
            titleEl.innerText = list.name;

            // Proses Deskripsi
            const fullDesc = list.desc || "No description provided.";
            const words = fullDesc.split(' ');
            
            const shortSpan = document.getElementById('descShort');
            const fullSpan = document.getElementById('descFull');
            const btn = document.getElementById('readMoreBtn');

            if (words.length > 8) {
                // Potong 8 kata pertama
                const shortText = words.slice(0, 8).join(' ') + '...';
                
                shortSpan.innerText = shortText;
                shortSpan.style.display = 'inline';
                
                fullSpan.innerText = fullDesc;
                fullSpan.style.display = 'none'; // Sembunyikan full text

                btn.style.display = 'inline'; // Tampilkan tombol read more
                btn.innerText = 'Read more';
            } else {
                // Jika pendek, tampilkan semua langsung
                shortSpan.innerText = fullDesc;
                fullSpan.style.display = 'none';
                btn.style.display = 'none';
            }
        }

        // --- FUNGSI TOGGLE READ MORE ---
        window.toggleDesc = function() {
            const shortSpan = document.getElementById('descShort');
            const fullSpan = document.getElementById('descFull');
            const btn = document.getElementById('readMoreBtn');

            if (shortSpan.style.display === 'none') {
                // Sedang Full -> Kembalikan ke Short
                shortSpan.style.display = 'inline';
                fullSpan.style.display = 'none';
                btn.innerText = 'Read more';
            } else {
                // Sedang Short -> Tampilkan Full
                shortSpan.style.display = 'none';
                fullSpan.style.display = 'inline';
                btn.innerText = 'Show less';
            }
        }

        // --- RENDER TASKS ---
        function renderTasks(tasks) {
            tasksWrapper.innerHTML = ''; // Clear loading

            if (tasks && tasks.length > 0) {
                tasks.forEach(task => {
                    const status = String(task.status || '').toLowerCase();
                    const isDone = ['done', 'completed', 'true', 'checklist'].includes(status);
                    const checkedAttr = isDone ? 'checked' : '';
                    const rowClass = isDone ? 'completed' : '';

                    const itemHtml = `
                        <div class="todo-row ${rowClass} d-flex align-items-start" onclick="toggleCheck(this)">
                            <input type="checkbox" class="todo-check" ${checkedAttr} onclick="event.stopPropagation()">
                            <div class="w-100">
                                <div class="todo-text">${task.title}</div>
                                <small class="text-muted" style="font-size:0.8rem;">Assigned to: Unassigned</small>
                            </div>
                        </div>
                    `;
                    tasksWrapper.insertAdjacentHTML('beforeend', itemHtml);
                });
            } else {
                tasksWrapper.innerHTML = '<div class="text-muted fst-italic text-center py-3">No tasks yet. Add one below!</div>';
            }
        }

        // --- ADD TASK LOGIC ---
        function showDetailForm() {
            document.getElementById('btn-add-detail').style.display = 'none';
            document.getElementById('form-add-detail').style.display = 'block';
            document.getElementById('input-task-detail').focus();
        }

        function hideDetailForm() {
            document.getElementById('btn-add-detail').style.display = 'inline-block';
            document.getElementById('form-add-detail').style.display = 'none';
            document.getElementById('input-task-detail').value = '';
        }

        function saveTaskDetail() {
            const input = document.getElementById('input-task-detail');
            const title = input.value;
            const btn = input.nextElementSibling.querySelector('.btn-success');

            if (!title) { alert("Please enter a task title"); return; }

            btn.innerText = "Saving...";
            btn.disabled = true;

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'createTask',
                    listId: listId,
                    title: title
                })
            })
            .then(res => res.json())
            .then(resp => {
                if(resp.status === 'success') {
                    // Refresh data tanpa reload page penuh
                    fetchDetailData();
                    hideDetailForm();
                } else {
                    alert("Error: " + resp.message);
                }
            })
            .catch(err => alert("Connection Error"))
            .finally(() => {
                btn.innerText = "Add this to-do";
                btn.disabled = false;
            });
        }

        function toggleSidebar() { document.getElementById('sidebarNav').classList.toggle('show'); }
        
        // Dummy Check Toggle (Visual Only)
        function toggleCheck(row) {
            const checkbox = row.querySelector('.todo-check');
            checkbox.checked = !checkbox.checked;
            if(checkbox.checked) row.classList.add('completed');
            else row.classList.remove('completed');
        }
    </script>
</body>
</html>
