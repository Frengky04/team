<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List - Dialogika</title>
    
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />

    <style>
        /* --- CSS KHUSUS LIST.HTML --- */
        body { background-color: #e5e7eb; }

        /* FIX LAYOUT: Pastikan konten ada di sebelah kanan sidebar */
        .main-content {
            margin-left: 290px;
            width: calc(100% - 290px);
            padding: 40px;
            min-height: 100vh;
        }
        @media (max-width: 991px) {
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
        }

        /* 1. KARTU HITAM (Project Context) */
        .project-context-card {
            max-width: 850px; width: 90%; margin: 20px auto -30px auto;
            background-color: #1f2937; color: white;
            padding: 20px 30px 45px 30px; border-radius: 16px 16px 0 0;
            position: relative; z-index: 1;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }

        .ph-badge {
            background: #FDE047; color: #854D0E; font-size: 0.7rem; font-weight: 800;
            padding: 4px 8px; border-radius: 4px; text-transform: uppercase;
            position: absolute; left: 30px; top: 50%; transform: translateY(-50%);
        }

        /* Menu Trigger */
        .ph-nav-group {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255, 255, 255, 0.1); padding: 6px 15px; border-radius: 50px;
            cursor: pointer; transition: 0.2s;
        }
        .ph-nav-group:hover { background: rgba(255, 255, 255, 0.2); }
        .ph-project-name { font-weight: 700; color: white; font-size: 1rem; }

        /* 2. KARTU PUTIH (Main Content) */
        .main-list-card {
            max-width: 1000px; width: 100%; margin: 0 auto 50px auto;
            background: white; border-radius: 16px;
            box-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.1);
            padding: 60px; position: relative; z-index: 2;
            border: 1px solid #d1d5db; min-height: 400px;
        }

        /* Tombol New List */
        .btn-new-list {
            position: absolute; top: 40px; right: 40px;
            background-color: #0B2B6A; color: white; border-radius: 50px;
            padding: 8px 24px; font-weight: 600; border: none;
            box-shadow: 0 4px 10px rgba(11, 43, 106, 0.2); transition: 0.2s;
        }
        .btn-new-list:hover { background-color: #08204e; transform: translateY(-2px); }

        /* Form New List */
        .new-list-form-wrapper {
            background: white; border: 1px solid #e5e7eb; border-radius: 12px;
            padding: 25px; margin-bottom: 40px; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .input-list-title {
            font-size: 1.5rem; font-weight: 700; border: none; width: 100%;
            outline: none; margin-bottom: 15px; color: #1f2937; border-bottom: 2px solid transparent;
        }
        .input-list-title:focus { border-bottom-color: #e5e7eb; }
        
        /* Empty State */
        .empty-state-card {
            border: 2px dashed #FDE047; background-color: #FFFCF5;
            border-radius: 12px; padding: 50px 20px; text-align: center;
            margin-top: 30px; display: none;
        }

        /* List Items Styling */
        .todo-group-label {
            font-size: 1.2rem; font-weight: 800; color: #1f2937;
            margin-top: 40px; margin-bottom: 15px; border-bottom: 3px solid #1f2937;
            display: inline-block; padding-bottom: 5px;
        }
        .todo-row {
            padding: 12px 10px; border-bottom: 1px solid #f3f4f6;
            display: flex; align-items: start; transition: 0.2s;
        }
        .todo-row:hover { background-color: #f8fafc; border-radius: 6px; }
        .todo-check { width: 22px; height: 22px; margin-right: 15px; cursor: pointer; }
        
        @media (max-width: 768px) {
            .ph-badge { display: none; }
            .main-list-card { padding: 30px 20px; border-radius: 0; }
            .btn-new-list { position: static; display: block; width: 100%; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <!-- 1. TOP BAR -->
    <nav class="top-bar">
        <div class="d-flex align-items-center">
            <button class="mobile-toggle me-3" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
            <div class="logo-center"><img src="https://www.dialogika.co/assets/img/logo.webp" height="35"></div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="profile-img-container"><img src="https://i.pravatar.cc/300?img=11" class="profile-img"></div>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <!-- 2. SIDEBAR -->
        <aside class="sidebar" id="sidebarNav">
            <div class="sidebar-scroll-wrapper">
                <div class="nav-category">Main Navigation</div>
                <a href="../home.html" class="sidebar-link"><i class="bi bi-columns-gap"></i> Dashboard</a>
                <a href="#" class="sidebar-link active"><i class="bi bi-list-columns-reverse"></i> Lineup</a>
                <div class="sidebar-copyright">&copy; 2025 PT Dialogika Persona Indonesia</div>
            </div>
        </aside>

        <!-- 3. MAIN CONTENT -->
        <main class="main-content">
            
            <!-- A. KARTU BELAKANG (HEADER HITAM) -->
            <div class="project-context-card">
                <!-- Badge Department -->
                <div class="ph-badge" id="projectBadge">Loading...</div>

                <!-- Dropdown Menu & Title -->
                <div class="dropdown">
                    <div class="ph-nav-group" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-grid-3x3-gap-fill text-secondary"></i>
                        <span class="ph-project-name" id="projectNameHeader">Loading Project...</span>
                    </div>
                    <ul class="dropdown-menu shadow border-0 rounded-4 mt-2 p-2">
                        <li><h6 class="dropdown-header text-uppercase small fw-bold">Jump to tool</h6></li>
                        <li><a class="dropdown-item rounded-2" href="#" id="linkBackToProject"><i class="bi bi-arrow-left me-2"></i> Back to Project</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item rounded-2" href="#"><i class="bi bi-kanban me-2 text-warning"></i> Kanban</a></li>
                        <li><a class="dropdown-item rounded-2" href="#"><i class="bi bi-file-earmark-text me-2 text-info"></i> Files</a></li>
                    </ul>
                </div>
            </div>

            <!-- B. KARTU DEPAN (LIST KONTEN) -->
            <div class="main-list-card">
                
                <!-- Tombol New List -->
                <button class="btn-new-list" onclick="toggleNewListForm()">
                    <i class="bi bi-plus-lg me-1"></i> New List
                </button>

                <!-- Judul Halaman -->
                <div class="text-center mb-5">
                    <h1 class="fw-bold display-5 mb-1" style="color:#111;">To-dos</h1>
                    <p class="text-muted">Manage your tasks efficiently.</p>
                </div>

                <!-- FORM NEW LIST (Hidden) -->
                <div id="newListForm" class="new-list-form-wrapper">
                    <input type="text" id="inputListName" class="input-list-title" placeholder="Name this list...">
                    <div class="border rounded mb-3 p-2 bg-white" style="min-height: 100px;" contenteditable="true" id="inputListDesc"></div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success rounded-pill px-4 btn-save-list" onclick="saveNewList()">Add this list</button>
                        <button class="btn btn-light border rounded-pill px-4" onclick="toggleNewListForm()">Cancel</button>
                    </div>
                </div>

                <!-- LOADING INDICATOR -->
                <div id="loadingState" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2">Loading lists...</p>
                </div>

                <!-- EMPTY STATE -->
                <div id="emptyState" class="empty-state-card">
                    <i class="bi bi-check-circle display-4 text-warning mb-3 d-block"></i>
                    <h3 class="fw-bold text-secondary">No to-do lists just yet</h3>
                    <p class="text-muted">Get started by creating a new list above.</p>
                </div>

                <!-- ERROR STATE -->
                <div id="errorState" class="alert alert-danger text-center" style="display: none;"></div>

                <!-- LIST CONTAINER -->
                <div id="listsContainer"></div>

            </div>
        </main>
    </div>

    <!-- Script JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. KONFIGURASI API (WAJIB DIGANTI) ---
        // GANTI URL DI BAWAH INI DENGAN URL WEB APP ANDA YANG BERAKHIRAN /exec
        const API_URL = 'https://script.google.com/macros/s/AKfycbzsRHbU5WcucXdIhQeOFBaWQFvqO1kwGk72dHIfYWKtNcQF7ds5tTOyZNAmEWCQX_M/exec';

        // Ambil ID dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');

        // --- 2. INIT LOAD ---
        document.addEventListener("DOMContentLoaded", function() {
            console.log("Project ID:", projectId);

            // Validasi ID
            if(!projectId) {
                showError("Error: Tidak ada Project ID di URL. <br><a href='../home.html' class='btn btn-sm btn-outline-danger mt-2'>Kembali ke Dashboard</a>");
                return;
            }
            if(!API_URL || API_URL.includes("PASTE_URL")) {
                showError("Error: API URL belum dikonfigurasi di file list.html");
                return;
            }

            // Set Link Back
            const backLink = document.getElementById('linkBackToProject');
            if(backLink) backLink.href = `../project/project.html?id=${projectId}`;

            // Fetch Data
            fetchListsData();
        });

        // --- 3. FETCH DATA ---
        function fetchListsData() {
            const loading = document.getElementById('loadingState');
            loading.style.display = 'block';

            fetch(`${API_URL}?action=getProjectData&id=${projectId}`)
            .then(res => res.json())
            .then(response => {
                loading.style.display = 'none';

                if(response.status === 'success') {
                    // Update Header
                    const proj = response.data.project;
                    document.getElementById('projectNameHeader').innerText = proj.name;
                    document.getElementById('projectBadge').innerText = proj.department || 'Project';

                    // Render List
                    renderLists(response.data.lists);
                } else {
                    showError(response.message);
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                console.error(err);
                showError("Gagal mengambil data. Cek koneksi internet.");
            });
        }

        // --- 4. RENDER LISTS ---
        function renderLists(lists) {
            const container = document.getElementById('listsContainer');
            const emptyState = document.getElementById('emptyState');
            
            container.innerHTML = ''; // Reset

            if (!lists || lists.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                
                lists.forEach(list => {
                    let tasksHtml = '';
                    
                    // Render Tasks
                    if (list.tasks && list.tasks.length > 0) {
                        list.tasks.forEach(task => {
                            // Cek status (case insensitive)
                            const status = String(task.status).toLowerCase();
                            const isDone = ['done', 'completed', 'true'].includes(status);
                            
                            tasksHtml += `
                                <div class="todo-row">
                                    <input type="checkbox" class="todo-check" ${isDone ? 'checked' : ''} disabled>
                                    <div class="ms-3">
                                        <div class="${isDone ? 'text-decoration-line-through text-muted' : 'text-dark'}">${task.title}</div>
                                        ${task.assignedTo ? `<small class="text-muted"><i class="bi bi-person-fill"></i> ${task.assignedTo}</small>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        tasksHtml = '<div class="text-muted small ps-4 fst-italic">No tasks yet.</div>';
                    }

                    // Render Group
                    const groupHtml = `
                        <div class="mb-5">
                            <div class="todo-group-label">${list.name}</div>
                            <p class="text-muted small mb-2">${list.desc || ''}</p>
                            <div class="border-top">${tasksHtml}</div>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill mt-3 ms-4 fw-bold">Add a to-do</button>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', groupHtml);
                });
            }
        }

        // --- 5. CREATE NEW LIST ---
        function saveNewList() {
            const name = document.getElementById('inputListName').value;
            const desc = document.getElementById('inputListDesc').innerText;
            const btn = document.querySelector('.btn-save-list');

            if(!name) { alert("List name cannot be empty"); return; }
            
            btn.innerText = "Saving...";
            btn.disabled = true;

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'createList',
                    projectId: projectId, // ID Project wajib dikirim
                    listName: name,
                    description: desc
                })
            })
            .then(res => res.json())
            .then(resp => {
                if(resp.status === 'success') {
                    // Reset
                    document.getElementById('inputListName').value = '';
                    document.getElementById('inputListDesc').innerText = '';
                    toggleNewListForm();
                    // Reload Data
                    fetchListsData();
                } else {
                    alert('Error: ' + resp.message);
                }
            })
            .catch(err => {
                alert("Gagal menyimpan. Cek koneksi.");
            })
            .finally(() => {
                btn.innerText = "Add this list";
                btn.disabled = false;
            });
        }

        // Helpers
        function toggleNewListForm() {
            const form = document.getElementById('newListForm');
            const empty = document.getElementById('emptyState');
            const container = document.getElementById('listsContainer');

            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                if(empty) empty.style.display = 'none';
            } else {
                form.style.display = 'none';
                if(container.innerHTML === '') empty.style.display = 'block';
            }
        }

        function showError(msg) {
            document.getElementById('loadingState').style.display = 'none';
            const errDiv = document.getElementById('errorState');
            errDiv.innerHTML = msg;
            errDiv.style.display = 'block';
        }

        function toggleSidebar() { document.getElementById('sidebarNav').classList.toggle('show'); }
    </script>
</body>
</html>
